{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<style>
    .chat-box {
        height: 400px;
        overflow-y: scroll;
        border: 1px solid #ddd;
        padding: 10px;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
    }

    .message {
        max-width: 70%;
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 10px;
        position: relative;
    }

    .message.user {
        align-self: flex-start;
        background: #e9ecef;
        color: #333;
    }

    .message.admin {
        align-self: flex-end;
        background: #007bff;
        color: white;
    }

    .message .meta {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-bottom: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Ticket #{{ ticket.id_str|default:ticket._id }}</h3>
                <div class="card-tools">
                    Status: <span class="badge badge-info">{{ ticket.status }}</span>
                </div>
            </div>
            <div class="card-body">
                <div id="chat-box" class="chat-box">
                    {% for msg in messages %}
                    <div class="message {{ msg.sender_role }}" title="{{ msg.sender_id }}">
                        <div class="meta">{{ msg.sender_role|title }} - {{ msg.created_at|date:"H:i" }}</div>
                        {{ msg.content }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="message-input" class="form-control" placeholder="Type a reply...">
                    <span class="input-group-append">
                        <button type="button" onclick="sendMessage()" class="btn btn-primary">Send</button>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Actions</h3>
            </div>
            <div class="card-body">
                <form method="post" action="">
                    {% csrf_token %}
                    <button type="submit" name="action" value="resolve" class="btn btn-success btn-block">
                        Mark as Resolved
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // WebSocket removed as per request
    // const wsUrl = "{{ ws_url }}";
    // const ws = new WebSocket(wsUrl);
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('message-input');

    // Auto scroll to bottom
    chatBox.scrollTop = chatBox.scrollHeight;

    function sendMessage() {
        // Fallback to HTTP or disabled
        alert("Real-time chat is disabled. Please refresh to see new messages.");
        const content = input.value.trim();
        if (!content) return;
        // submit via form or ajax (not implemented here yet)
        input.value = "";
    }

    input.addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function appendMessage(data) {
        const div = document.createElement('div');
        div.className = 'message ' + data.sender_role;
        div.innerHTML = `
            <div class="meta">${data.sender_role} - Now</div>
            ${data.content}
        `;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
{% endblock %}